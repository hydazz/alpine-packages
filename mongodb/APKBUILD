# Maintainer: Marc Vertes <mvertes@free.fr>
# Contributor: Filipp Andronov <filipp.andronov@gmail.com>
pkgname=mongodb
pkgver=4.4.2
pkgrel=0
pkgdesc="A high-performance, open source, schema-free document-oriented database"
url="http://www.mongodb.org"
arch="x86_64 ppc64le aarch64"
options="!check" # out of disk space (>35GB)
license='AGPL3'
pkgusers="mongodb"
pkggroups="mongodb"
makedepends="scons python3 py3-setuptools py3-cheetah py3-psutil py3-typing-extensions py3-yaml paxmark
	openssl-dev pcre-dev snappy-dev boost-dev asio-dev libpcap-dev
	snowball-dev zlib-dev cyrus-sasl-dev yaml-cpp-dev libcurl curl-dev"
install="$pkgname.pre-install"
source="http://downloads.mongodb.org/src/mongodb-src-r${pkgver}.tar.gz
	fix-backtrace.patch
	fix-default-stacksize.patch
	fix-elf-native-class.patch
	fix-processinfo_linux.patch
	fix-resolv.patch
	wiredtiger.patch
	mongodb.confd
	mongodb.initd
	mongodb.logrotate
	mongos.confd
	mongos.initd
	"

builddir="$srcdir"/$pkgname-src-r$pkgver
_buildopts="
	--allocator=system \
	--disable-warnings-as-errors \
	--use-system-boost \
	--use-system-pcre \
	--use-system-stemmer \
	--use-system-snappy \
	--use-system-zlib \
	--use-system-yaml \
	--use-sasl-client \
	--ssl \
	"

case $CARCH in
aarch64) _buildopts="$_buildopts CCFLAGS=-march=armv8-a+crc" ;;
esac

build() {
  cd "$builddir"
  export SCONSFLAGS="$MAKEFLAGS"
  scons $_buildopts --prefix=$pkgdir/usr core
}

check() {
  cd "$builddir"

  export SCONSFLAGS="$MAKEFLAGS"
  scons $_buildopts unittests
  python buildscripts/resmoke.py --suites=unittests --jobs=2
}

package() {
  cd "$builddir"

  # install mongo targets
  export SCONSFLAGS="$MAKEFLAGS"
  scons $_buildopts --prefix=$pkgdir/usr install

  # java jit requires paxmark
  paxmark -m "$pkgdir"/usr/bin/mongo*

  # install alpine specific files
  install -dm700 "$pkgdir/var/lib/mongodb"
  install -dm755 "$pkgdir/var/log/mongodb"
  chown mongodb:mongodb "$pkgdir/var/lib/mongodb" "$pkgdir/var/log/mongodb"

  install -Dm755 "$srcdir/mongodb.initd" "$pkgdir/etc/init.d/mongodb"
  install -Dm644 "$srcdir/mongodb.confd" "$pkgdir/etc/conf.d/mongodb"
  install -Dm644 "$srcdir/mongodb.logrotate" "$pkgdir/etc/logrotate.d/mongodb"

  install -Dm755 "$srcdir/mongos.initd" "$pkgdir/etc/init.d/mongos"
  install -Dm644 "$srcdir/mongos.confd" "$pkgdir/etc/conf.d/mongos"
}

sha512sums="bbf59ed97a8718576c469c696d5331c122f63528dad950fd415b00269c2fa5e6949b372c575e2504c2a58b145bae485172b25000000481662e6543bc3127252a  mongodb-src-r4.4.2.tar.gz
8070522f6e52f23fda56cf16eefdbd9a18cbbda707169657ca05d0d025f90b31fe4c28c40c3c1bdf9c7ee37c90d388d32b1d1ab255fd9c1d6dcd0671b7757175  fix-backtrace.patch
dc6442f9281894a01313afc81ff18b79194b148df4b8f575bf2669adb8b9adec6a2d28e220016d61227091bb8fa47c27dfb56b856419f45dd6bff5fc1b4868ee  fix-default-stacksize.patch
4a8c84ea49ec807cf197764ff48e029db855ad3786e230cb0324449f3ebe4ad23899e7c18c29adc0a9ff23e581b77829d18f10cf3de8f5c87cb97829b85b85fc  fix-elf-native-class.patch
d344c48f9b771f1193aa84a563a02bb5433e28154ff74f6ccb288797bba979685dcc03145016bae71a513725241a1c479faad6a32f00ffa9a686bc448fff26c6  fix-processinfo_linux.patch
633d26ce0047d698f4c3848147a41e355097212a49d798473c247d07198a8850bcc5fd43ce7b2c02b0711c453f6ed40b98888f9caca154e97ad10bfbfec3791a  fix-resolv.patch
201911e4af2defbd42027ffc509c196d6454bd673c0e619eed29037945c08866203fa24b6511dd6092c1e6b0454f1caec934a04ed4a0f6d81401068c190e5766  wiredtiger.patch
9bcd870742c31bf25f34188ddc3c414de1103e9860dea9f54eee276b89bc2cf1226abab1749c5cda6a6fb0880e541373754e5e83d63cc7189d4b9c274fd555c3  mongodb.confd
74009794d566dd9d70ec93ffd95c830ee4696165574ecf87398165637fb40799b38d182ef54c50fd0772d589be94ade7f7a49247f3d31c1f012cb4e44cc9f5df  mongodb.initd
8c089b1a11f494e4148fb4646265964c925bf937633a65e395ee1361d42facf837871dd493a9a2e0f480ae0e0829dbd3ed60794c5334e2716332e131fc5c2c51  mongodb.logrotate
61d8734cef644187eeadc821c89e63a3fbf61860fe2db6e74557b1c6760fe83ba7549cb04f9e3aacea4d8e7e4d81a3b1bc0d5e29715eca33c4761adb17ea9ab7  mongos.confd
13aad7247b848ac58b2bc0b40a0d30d909e950380abd0c83fab0e2a394a42dc268a66dac53cf9feec6971739977470082cc4339cca827f41044cfe43803ef3f7  mongos.initd"
